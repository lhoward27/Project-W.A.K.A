[gd_scene load_steps=10 format=3 uid="uid://b5m6l3hj8a28g"]

[ext_resource type="Texture2D" uid="uid://by6b1ng8lw46q" path="res://assets/textures/dev/grids/Dark/texture_07.png" id="1_idj7w"]
[ext_resource type="Texture2D" uid="uid://d3b2las2qe285" path="res://assets/hdris/kloofendal_48d_partly_cloudy_puresky_2k.hdr" id="2_kln2b"]

[sub_resource type="GDScript" id="GDScript_idj7w"]
resource_name = "res://Script/Player.gd"
script/source = "extends CharacterBody3D

# Player nodes
@onready var neck: Node3D = $Neck
@onready var head: Node3D = $Neck/Head
@onready var standing_cs: CollisionShape3D = $Standing_CS
@onready var crouching_cs: CollisionShape3D = $Crouching_CS
@onready var ray_cast_3d: RayCast3D = $RayCast3D

# Speed Vars
var current_speed = 5.0
@export var walking_speed = 5.0
@export var sprinting_speed = 8.0
@export var crouching_speed = 3.0
@export var mouse_sens = 0.4
var lerp_speed = 25

# Movement Vars
const jump_velocity = 6.5
var direction = Vector3()
var crouching_depth = -0.5

# States
var walking = false
var sprinting = false
var crouching = false
var free_looking = false
var sliding = false

# Gravity Vars
var gravity = 20
var fall_gravity = 30
var is_rising = false

func _ready() -> void:
	Input.set_mouse_mode(Input.MOUSE_MODE_CAPTURED)
	
func _input(event: InputEvent) -> void:
	# Mouse looking logic
	if event is InputEventMouseMotion:
		if free_looking:
			neck.rotate_y(deg_to_rad(-event.relative.x * mouse_sens))
		else:
			head.rotate_x(deg_to_rad(-event.relative.y * mouse_sens))
			head.rotation.x = clamp(head.rotation.x,deg_to_rad(-89), deg_to_rad(89))
		

func _physics_process(delta: float) -> void:
	
	# Handles jumping gravity
	if velocity.y < 0:
		is_rising = true
	else:
		is_rising = false
		
	if not is_on_floor():
		if is_rising:
			gravity = 20
		else:
			gravity = fall_gravity
	else:
		gravity = 20
	velocity.y -= gravity * delta
	
	# Handle movement states
	# Crouching
	if Input.is_action_pressed(\"Crouch\"):
		current_speed = crouching_speed
		head.position.y = lerp(head.position.y, crouching_depth, delta * lerp_speed)
		standing_cs.disabled = true
		crouching_cs.disabled = false
		
		walking = false
		sprinting = false
		crouching = true
		
	# Standing
	elif !ray_cast_3d.is_colliding():
		
		standing_cs.disabled = false
		crouching_cs.disabled = true
		
		head.position.y = lerp(head.position.y, 0.0, delta * lerp_speed)
			# Sprinting
		if Input.is_action_pressed(\"Sprint\"):
			current_speed = sprinting_speed
			walking = false
			sprinting = true
			crouching = false
		else:
			# Walking
			current_speed = walking_speed
			walking = true
			sprinting = false
			crouching = false
			
	# Handle Free Look
	if Input.is_action_pressed(\"free_look\"):
		free_looking = true
	else:
		free_looking = false
	# Handle jump.
	if Input.is_action_just_pressed(\"ui_accept\") and is_on_floor():
		velocity.y = jump_velocity

	# Get the input direction and handle the movement/deceleration.
	# As good practice, you should replace UI actions with custom gameplay actions.
	var input_dir := Input.get_vector(\"Left\", \"Right\", \"Forward\", \"Backward\")
	direction = lerp(direction, (transform.basis * Vector3(input_dir.x, 0, input_dir.y)).normalized(), delta * lerp_speed)
	if direction:
		velocity.x = direction.x * current_speed
		velocity.z = direction.z * current_speed
	else:
		velocity.x = move_toward(velocity.x, 0, current_speed)
		velocity.z = move_toward(velocity.z, 0, current_speed)

	move_and_slide()
"

[sub_resource type="CapsuleShape3D" id="CapsuleShape3D_kln2b"]

[sub_resource type="CapsuleShape3D" id="CapsuleShape3D_idj7w"]
height = 1.2

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_rgh2o"]
albedo_texture = ExtResource("1_idj7w")
uv1_triplanar = true

[sub_resource type="PanoramaSkyMaterial" id="PanoramaSkyMaterial_pbw6q"]
panorama = ExtResource("2_kln2b")

[sub_resource type="Sky" id="Sky_v1gob"]
sky_material = SubResource("PanoramaSkyMaterial_pbw6q")

[sub_resource type="Environment" id="Environment_jw32o"]
background_mode = 2
sky = SubResource("Sky_v1gob")
tonemap_mode = 2
glow_enabled = true

[node name="World" type="Node3D"]

[node name="Player" type="CharacterBody3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0)
script = SubResource("GDScript_idj7w")

[node name="Standing_CS" type="CollisionShape3D" parent="Player"]
shape = SubResource("CapsuleShape3D_kln2b")

[node name="Crouching_CS" type="CollisionShape3D" parent="Player"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -0.4, 0)
shape = SubResource("CapsuleShape3D_idj7w")
disabled = true

[node name="RayCast3D" type="RayCast3D" parent="Player"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -1, 0)
target_position = Vector3(0, 2, 0)

[node name="Neck" type="Node3D" parent="Player"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.5, 0)

[node name="Head" type="Node3D" parent="Player/Neck"]

[node name="Camera3D" type="Camera3D" parent="Player/Neck/Head"]

[node name="Stage" type="Node3D" parent="."]

[node name="CSGBox3D" type="CSGBox3D" parent="Stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -0.5, 0)
use_collision = true
size = Vector3(20, 1, 20)
material = SubResource("StandardMaterial3D_rgh2o")

[node name="CSGBox3D2" type="CSGBox3D" parent="Stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1.7376, -11.6663)
use_collision = true
size = Vector3(20, 1, 20)
material = SubResource("StandardMaterial3D_rgh2o")

[node name="CSGBox3D3" type="CSGBox3D" parent="Stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -17.0844, 0.086062, 0)
use_collision = true
size = Vector3(20, 1, 20)
material = SubResource("StandardMaterial3D_rgh2o")

[node name="CSGBox3D4" type="CSGBox3D" parent="Stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -20.1584, 0.983532, -2.98511)
use_collision = true
size = Vector3(20, 1, 20)
material = SubResource("StandardMaterial3D_rgh2o")

[node name="CSGBox3D5" type="CSGBox3D" parent="Stage"]
transform = Transform3D(1.6203, 0.21369, -0.139105, -0.292574, 1.37755, -0.123489, 0.231922, 0.24488, 0.816063, -11.9874, 0.851878, -8.01896)
use_collision = true
size = Vector3(20, 1, 20)
material = SubResource("StandardMaterial3D_rgh2o")

[node name="Env" type="Node3D" parent="."]

[node name="WorldEnvironment" type="WorldEnvironment" parent="Env"]
environment = SubResource("Environment_jw32o")

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="Env"]
transform = Transform3D(-0.866023, -0.433016, 0.250001, 0, 0.499998, 0.866027, -0.500003, 0.749999, -0.43301, 0, 0, 0)
shadow_enabled = true
